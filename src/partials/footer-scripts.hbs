<script src="{{{uiRootPath}}}/js/site.js"></script>
<script async src="{{{uiRootPath}}}/js/vendor/highlight.js"></script>
<script async src="{{{uiRootPath}}}/js/vendor/clipboard.js"></script>
<script async src="{{{uiRootPath}}}/js/vendor/medium-zoom.js"></script>
<script async src="{{{uiRootPath}}}/js/vendor/collapse.js"></script>

{{!-- Native Search Widget --}}
<script src="{{{uiRootPath}}}/js/vendor/magnolia-search.js"></script>

{{!-- Ask AI Widget --}}
<script src="{{{uiRootPath}}}/js/vendor/magnolia-ask-ai.js"></script>
<link rel="stylesheet" href="{{{uiRootPath}}}/css/magnolia-ask-ai.css">

<script type="text/javascript">
(function() {
  'use strict';
  
  function initNativeSearch() {
    if (typeof MagnoliaSearchUI === 'undefined') {
      console.warn('MagnoliaSearchUI not loaded');
      return;
    }
    
    var container = document.getElementById('nativeSearch');
    if (!container) {
      console.warn('Search container #nativeSearch not found');
      return;
    }
    
    // Enable dev mode ONLY in preview environment (localhost) - NEVER in production
    // Production will show error message if index fails, never dummy results
    var isPreview = window.location && (
      window.location.hostname === 'localhost' || 
      window.location.hostname === '127.0.0.1' || 
      window.location.port === '5252'
    );
    var hasDisableParam = window.location && window.location.search.indexOf('searchDevMode=false') !== -1;
    // Dev mode is ONLY enabled in preview (localhost), never in production
    // Even if ?searchDevMode=true is added to production URL, it will be ignored for safety
    // This ensures production never shows dummy results, only error messages if index fails
    var enableDevMode = isPreview && !hasDisableParam;
    
    new MagnoliaSearchUI({
      container: '#nativeSearch',
      indexUrl: '/search-data/search-index.min.json',
      metadataUrl: '/search-data/metadata.json',
      placeholder: 'Search Magnolia docsâ€¦',
      hotkey: '/',
      maxResults: 15,
      showFilters: true,
      showFooter: true,
      branding: 'Powered by Magnolia NativeSearch',
      devMode: enableDevMode, // Enable dev mode in preview for styling work
      filters: [
        { key: '', label: 'All' },
        { key: 'latest', label: 'Latest' },
        { key: '6.3', label: '6.3' },
        { key: '6.2', label: '6.2' },
        { key: 'cloud', label: 'DX Cloud' },
        { key: 'modules', label: 'Modules' }
      ]
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNativeSearch);
  } else {
    initNativeSearch();
  }
  
  function initAskAI() {
    if (typeof MagnoliaAskAIUI === 'undefined') {
      console.warn('MagnoliaAskAIUI not loaded');
      return;
    }
    
    var container = document.getElementById('askAI');
    if (!container) {
      console.warn('Ask AI container #askAI not found');
      return;
    }
    
    // Feature flag - set to true to enable Ask AI widget
    var askAIEnabled = true; // Change to true to enable
    
    if (!askAIEnabled) {
      return;
    }
    
    // Detect preview environment
    var isPreview = window.location && (
      window.location.hostname === 'localhost' || 
      window.location.hostname === '127.0.0.1' || 
      window.location.port === '5252'
    );
    
    // Configure chunks URL
    var chunksUrl = '/search-data/llm-chunks.json'; // Production path
    
    if (isPreview) {
      // Local development: file is in public/ directory, served at root
      var localChunksPath = '/llm-chunks.json';
      chunksUrl = localChunksPath;
    }
    
    new MagnoliaAskAIUI({
      container: '#askAI',
      chunksUrl: chunksUrl,
      apiEndpoint: isPreview ? 'http://localhost:3000/api/ask' : '/api/ask', // Local API for preview, production URL for prod
      placeholder: 'Ask a question about Magnolia...',
      hotkey: '?', // On Mac: Command+/, Windows/Linux: Ctrl+/ or Shift+/
      enabled: true,
      position: 'header', // 'header' | 'bottom-left' | 'bottom-right'
      showFilters: true,
      showFooter: true,
      branding: 'Powered by Magnolia AI',
      maxQuestionsPerSession: 12,
      filters: [
        { key: '', label: 'All' },
        { key: 'latest', label: 'Latest' },
        { key: '6.3', label: '6.3' },
        { key: '6.2', label: '6.2' },
        { key: 'cloud', label: 'DX Cloud' },
        { key: 'modules', label: 'Modules' }
      ]
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAskAI);
  } else {
    initAskAI();
  }
  
  function toggleDropDown() {
    var linkEl = document.querySelectorAll('.has-dropdown');
    var allDrops = document.querySelectorAll('.has-dropdown .navbar-dropdown');
    for (var i = 0; i < linkEl.length; i++) {
      linkEl[i].addEventListener('click', function(e) {
        for (var j = 0; j < allDrops.length; j++) {
          allDrops[j].style.display = "none";
        }
        e.stopPropagation();
        if (e.target.nextElementSibling) {
          e.target.nextElementSibling.style.display = "block";
        }
      });
    }
  }
  
  if (window.innerWidth < 1200) {
    toggleDropDown();
  }
})();
</script>